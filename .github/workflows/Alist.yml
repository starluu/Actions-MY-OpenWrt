name: Download and Upload to Tianyi Cloud

on:
  workflow_dispatch:
    inputs:
      file_url:
        description: 'File URL to download'
        required: true

jobs:
  process:
    runs-on: ubuntu-latest
    container:
      image: xhofe/alist:latest-aio
      options: --dns=8.8.8.8 -v /tmp/data:/opt/alist/data

    steps:
    - name: Install dependencies
      run: |
        # 安装必要的工具
        apk update
        apk add jq curl
        
    - name: Start Alist service
      run: |
        # 启动Alist服务
        nohup ./alist server > /dev/null 2>&1 &
        sleep 10  # 等待服务启动

    - name: Get admin password
      id: get_password
      run: |
        # 从日志中提取初始密码
        password=$(cat data/log/log.log | grep "password" | awk '{print $NF}')
        echo "ALIST_PASSWORD=$password" >> $GITHUB_ENV

    - name: Configure Tianyi Cloud storage
      env:
        TIANYI_USER: ${{ secrets.TIANYI_USERNAME }}
        TIANYI_PWD: ${{ secrets.TIANYI_PASSWORD }}
      run: |
        # 获取登录Token
        token=$(curl -s -X POST http://localhost:5244/api/auth/login \
          -H 'Content-Type: application/json' \
          -d "{\"username\":\"admin\",\"password\":\"$ALIST_PASSWORD\"}" | \
          jq -r '.data.token')

        # 添加天翼云盘存储
        curl -X POST http://localhost:5244/api/admin/storage \
          -H "Authorization: $token" \
          -H 'Content-Type: application/json' \
          -d "{
            \"mount_path\": \"/tianyi\",
            \"order\": 0,
            \"driver\": \"Cloud189\",
            \"cache_expiration\": 30,
            \"status\": \"work\",
            \"addition\": \"{\\\"username\\\":\\\"$TIANYI_USER\\\",\\\"password\\\":\\\"$TIANYI_PWD\\\"}\"
          }"

    - name: Download file with Aria2
      run: |
        # 使用内置的Aria2下载文件
        aria2c -d /opt/alist/data/downloads \
          -o downloaded_file \
          "${{ github.event.inputs.file_url || secrets.DOWNLOAD_URL }}"

    - name: Upload to Tianyi Cloud
      env:
        ALIST_PASSWORD: ${{ env.ALIST_PASSWORD }}
      run: |
        # 获取登录Token
        token=$(curl -s -X POST http://localhost:5244/api/auth/login \
          -H 'Content-Type: application/json' \
          -d "{\"username\":\"admin\",\"password\":\"$ALIST_PASSWORD\"}" | \
          jq -r '.data.token')

        # 通过API上传文件
        curl -X POST http://localhost:5244/api/fs/put \
          -H "Authorization: $token" \
          -F "file=@/opt/alist/data/downloads/downloaded_file" \
          -F "path=/tianyi"

        # 监控上传任务状态
        while true; do
          status=$(curl -s -H "Authorization: $token" \
            http://localhost:5244/api/admin/task/upload | jq '.data[0].status')
          
          if [[ "$status" == '"completed"' ]]; then
            echo "Upload completed successfully"
            break
          elif [[ "$status" == '"error"' ]]; then
            echo "Upload failed" >&2
            exit 1
          fi
          sleep 10
        done
