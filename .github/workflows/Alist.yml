name: Alist-AIO 自动化传输

on:
  workflow_dispatch:

jobs:
  alist-automation:
    runs-on: ubuntu-latest
    
    steps:
    # ========== 初始阶段：内网穿透 ==========
    - name: 使用 cpolar 穿透
      run: |
        # 下载 cpolar
        wget https://www.cpolar.com/static/downloads/releases/3.3.18/cpolar-stable-linux-amd64.zip
        unzip cpolar-stable-linux-amd64.zip
        
        # 设置认证令牌（在 https://dashboard.cpolar.com 获取）
        ./cpolar authtoken ${{ secrets.CPOLAR_TOKEN }} 
        
        # 启动隧道
        ./cpolar http 9000 > /dev/null &
        ./cpolar http 6880 > /dev/null &
        ./cpolar http 6881 > /dev/null &
        
    - name: 使用 Ngrok 穿透
      run: |
        # 下载 ngrok
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar xvzf ngrok-v3-stable-linux-amd64.tgz
        
        # 设置认证令牌（在 https://dashboard.ngrok.com 获取）
        ./ngrok authtoken ${{ secrets.NGROK_TOKEN }}
        
        # 启动隧道
        ./ngrok http 5244 > /dev/null &
        
    # ========== 部署阶段：容器初始化 ==========
    - name: 启动 portainer 容器
      run: |
        docker run -d --restart=always --name="portainer" -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock 6053537/portainer-ce

        
    - name: 启动 ariang 容器
      run: |        
        docker run -d --name ariang --restart=always -p 6880:6880 p3terx/ariang
        
    - name: 启动 qbittorrent 容器
      run: |        
        docker create  \
            --name=qbittorrentee  \
            -e WEBUIPORT=8080  \
            -e PUID=1026 \
            -e PGID=100 \
            -e TZ=Asia/Shanghai \
            -p 6881:6881  \
            -p 6881:6881/udp  \
            -p 8080:8080  \
            -v /path/to/appdata/config:/config  \
            -v /path/to/downloads:/downloads  \
            --restart=always  \
            superng6/qbittorrentee
    
    - name: 启动 Alist-AIO 容器
      run: |
        docker run -d --name alist-aio \
          -p 5244:5244 \
          -p 6800:6800 \
          xhofe/alist:latest-aio
          docker exec alist-aio ./alist admin set admin
          NGROK_URL=$(curl -s localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          echo "ALIST_PUBLIC_URL=$NGROK_URL" >> $GITHUB_ENV
          echo "🌐 Alist 已暴露在公网: $NGROK_URL"          
          echo "⏳ 等待手动配置天翼云存储..."
          echo "👉 预留6小时手动操作时间"
        sleep 6h
