name: Alist-AIO è‡ªåŠ¨åŒ–ä¼ è¾“

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: "ğŸ”— è¦ä¸‹è½½çš„æ–‡ä»¶URL (å¿…é¡» http/https å¼€å¤´)"
        required: true
        default: "https://example.com/demo-file.zip"
      cloud_path:
        description: "â˜ï¸ å¤©ç¿¼äº‘ä¿å­˜è·¯å¾„ (å¦‚ /å¤‡ä»½/2024/)"
        required: false
        default: "/è‡ªåŠ¨å¤‡ä»½/"
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥UTC 0ç‚¹è‡ªåŠ¨è¿è¡Œ

jobs:
  alist-automation:
    runs-on: ubuntu-latest
    steps:
    # ========== ç¬¬ä¸€é˜¶æ®µï¼šå®¹å™¨åˆå§‹åŒ– ==========
    - name: å¯åŠ¨Alist-AIOå®¹å™¨
      run: |
        docker run -d --name alist-aio \
          -p 5244:5244 \
          -p 6800:6800 \
          -e PASSWORD=${{ secrets.ALIST_ADMIN_PW }} \
          -e ARIA2_SECRET=${{ secrets.ARIA2_TOKEN }} \
          xhofe/alist:latest-aio
        sleep 20  # ç­‰å¾…æœåŠ¡å¯åŠ¨

    # ========== ç¬¬äºŒé˜¶æ®µï¼šè¾“å…¥éªŒè¯ ==========
    - name: éªŒè¯è¾“å…¥å‚æ•°
      run: |
        # éªŒè¯URLæ ¼å¼
        if [[ ! "${{ github.event.inputs.download_url }}" =~ ^https?:// ]]; then
          echo "âŒ é”™è¯¯ï¼šéæ³•çš„URLæ ¼å¼ï¼Œå¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´"
          exit 1
        fi

        # æ ‡å‡†åŒ–äº‘ç«¯è·¯å¾„æ ¼å¼
        CLOUD_PATH="${{ github.event.inputs.cloud_path || '/è‡ªåŠ¨å¤‡ä»½/'}}"
        if [[ ! "$CLOUD_PATH" =~ /$ ]]; then
          CLOUD_PATH="${CLOUD_PATH}/"  # ç¡®ä¿è·¯å¾„ä»¥/ç»“å°¾
        fi
        echo "CLOUD_PATH=${CLOUD_PATH}" >> $GITHUB_ENV

    # ========== ç¬¬ä¸‰é˜¶æ®µï¼šå­˜å‚¨é…ç½® ==========
    - name: é…ç½®å¤©ç¿¼äº‘å­˜å‚¨
      env:
        TIANYI_USER: ${{ secrets.TIANYI_USERNAME }}
        TIANYI_PASS: ${{ secrets.TIANYI_WEBDAV_PW }}
      run: |
        # è·å–ç®¡ç†å‘˜Token
        docker exec -it alist-aio ./alist admin set ${{ secrets.ALIST_ADMIN_PW }}
        TOKEN=$(curl -s -X POST http://localhost:5244/api/auth/login \
          -H "Content-Type: application/json" \
          -d '{"username": "admin", "password": "'"${{ secrets.ALIST_ADMIN_PW }}"'"}' | jq -r .data.token)

        # åŠ¨æ€åˆ›å»ºå­˜å‚¨é…ç½®
        curl -X POST http://localhost:5244/api/admin/storage/create \
          -H "Authorization: $TOKEN" \
          -H "Content-Type: application/json" \
          -d '{
            "mount_path": "/tianyi-cloud",
            "driver": "189Cloud",
            "username": "'"$TIANYI_USER"'",
            "password": "'"$TIANYI_PASS"'",
            "root_folder": "'"$CLOUD_PATH"'"
          }'

    # ========== ç¬¬å››é˜¶æ®µï¼šæ–‡ä»¶ä¸‹è½½ ==========
    - name: æ™ºèƒ½ä¸‹è½½æ–‡ä»¶
      run: |
        # æå–æ–‡ä»¶åå¹¶å¤„ç†ç‰¹æ®Šå­—ç¬¦
        RAW_URL="${{ github.event.inputs.download_url }}"
        FILENAME=$(basename "${RAW_URL%%\?*}" | sed 's/%20/ /g')  # å»é™¤URLå‚æ•°å¹¶è§£ç ç©ºæ ¼
        
        # é€šè¿‡Aria2ä¸‹è½½
        curl -s http://localhost:6800/jsonrpc \
          -H "Content-Type: application/json" \
          -d '{
            "jsonrpc": "2.0",
            "id": "github-action",
            "method": "aria2.addUri",
            "params": [
              "token:${{ secrets.ARIA2_TOKEN }}",
              ["'"$RAW_URL"'"],
              {
                "dir": "/opt/alist/data/downloads",
                "out": "'"$FILENAME"'",
                "split": "10",
                "max-connection-per-server": "8",
                "allow-overwrite": "true"
              }
            ]
          }'

        # ç›‘æ§ä¸‹è½½è¿›åº¦ï¼ˆæœ€é•¿ç­‰å¾…6å°æ—¶ï¼‰
        timeout 6h bash -c '
          while true; do
            STATUS=$(curl -s http://localhost:6800/jsonrpc \
              -d "{\"jsonrpc\":\"2.0\",\"id\":\"1\",\"method\":\"aria2.tellActive\",\"params\":[\"token:${{ secrets.ARIA2_TOKEN }}\"]}")
            if [ $(echo "$STATUS" | jq ".result | length") -eq 0 ]; then
              break
            fi
            echo "âŒ› ä¸‹è½½è¿›åº¦ï¼š$(echo "$STATUS" | jq ".result[0].completedLength")/$(echo "$STATUS" | jq ".result[0].totalLength")"
            sleep 30
          done
        ' || echo "âš ï¸ è­¦å‘Šï¼šä¸‹è½½ä»»åŠ¡å¯èƒ½æœªå®Œæˆ"

    # ========== ç¬¬äº”é˜¶æ®µï¼šæ–‡ä»¶ä¸Šä¼  ==========
    - name: å®‰å…¨ä¸Šä¼ åˆ°å¤©ç¿¼äº‘
      run: |
        FILENAME=$(basename "${{ github.event.inputs.download_url }}" | sed 's/%20/ /g')
        LOCAL_PATH="/opt/alist/data/downloads/$FILENAME"

        # è·å–ç®¡ç†å‘˜Token
        TOKEN=$(curl -s -X POST http://localhost:5244/api/auth/login \
          -H "Content-Type: application/json" \
          -d '{"username": "admin", "password": "'"${{ secrets.ALIST_ADMIN_PW }}"'"}' | jq -r .data.token)

        # åˆ†å—ä¸Šä¼ ï¼ˆé€‚åˆå¤§æ–‡ä»¶ï¼‰
        curl -X PUT http://localhost:5244/api/fs/form \
          -H "Authorization: $TOKEN" \
          -F "path=/tianyi-cloud/$FILENAME" \
          -F "file=@$LOCAL_PATH" \
          -F "chunk_index=0" \
          -F "chunk_count=1"

    # ========== ç¬¬å…­é˜¶æ®µï¼šæ”¶å°¾å·¥ä½œ ==========
    - name: æ¸…ç†å’Œæ—¥å¿—
      if: always()
      run: |
        # è·å–å®¹å™¨æ—¥å¿—
        docker logs alist-aio > alist.log 2>&1

        # æ¸…ç†å®¹å™¨
        docker stop alist-aio || true
        docker rm alist-aio || true

        # ä¸Šä¼ æ—¥å¿—ä¾›è°ƒè¯•
        echo "========== AListæ—¥å¿— =========="
        cat alist.log
