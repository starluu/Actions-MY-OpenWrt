name: Alist-AIO è‡ªåŠ¨åŒ–ä¼ è¾“

on:
  workflow_dispatch:
    inputs:
      download_url:
        description: "ğŸ”— è¦ä¸‹è½½çš„æ–‡ä»¶URL (å¿…é¡» http/https å¼€å¤´)"
        required: true
        default: "https://example.com/demo-file.zip"
      cloud_path:
        description: "â˜ï¸ å¤©ç¿¼äº‘ä¿å­˜è·¯å¾„ (å¦‚ /å¤‡ä»½/2024/)"
        required: false
        default: "/è‡ªåŠ¨å¤‡ä»½/"
  schedule:
    - cron: '0 0 * * *'  # æ¯æ—¥UTC 0ç‚¹è‡ªåŠ¨è¿è¡Œ

jobs:
  alist-automation:
    runs-on: ubuntu-latest
    steps:
    # ========== åˆå§‹é˜¶æ®µï¼šå†…ç½‘ç©¿é€ ==========
    - name: ä½¿ç”¨ Ngrok æš´éœ²ç«¯å£
      run: |
        # ä¸‹è½½ ngrok
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar xvzf ngrok-v3-stable-linux-amd64.tgz
        
        # è®¾ç½®è®¤è¯ä»¤ç‰Œï¼ˆåœ¨ https://dashboard.ngrok.com è·å–ï¼‰
        ./ngrok authtoken ${{ secrets.NGROK_TOKEN }}
        
        # å¯åŠ¨éš§é“
        ./ngrok http 5244 > /dev/null &
        
        # è·å–å…¬å…± URL
        sleep 5
        NGROK_URL=$(curl -s localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        echo "ALIST_PUBLIC_URL=$NGROK_URL" >> $GITHUB_ENV
        echo "ğŸŒ Alist å·²æš´éœ²åœ¨å…¬ç½‘: $NGROK_URL"
        
    # ========== ç¬¬ä¸€é˜¶æ®µï¼šå®¹å™¨åˆå§‹åŒ– ==========
    - name: å¯åŠ¨Alist-AIOå®¹å™¨
      run: |
        docker run -d --name alist-aio \
          -p 5244:5244 \
          -p 6800:6800 \
          -e PASSWORD=${{ secrets.ALIST_ADMIN_PW }} \
          -e ARIA2_SECRET=${{ secrets.ARIA2_TOKEN }} \
          xhofe/alist:latest-aio
          echo "â³ ç­‰å¾…æ‰‹åŠ¨é…ç½®å¤©ç¿¼äº‘å­˜å‚¨..."
          echo "ğŸ‘‰ è¯·è®¿é—® http://localhost:5244 å®Œæˆé…ç½®"
        sleep 1h  # é¢„ç•™1å°æ—¶æ‰‹åŠ¨æ“ä½œæ—¶é—´

    - name: éªŒè¯å­˜å‚¨é…ç½®
      run: |
        TOKEN=$(curl -s -X POST http://localhost:5244/api/auth/login \
         -H "Content-Type: application/json" \
         -d '{"username": "admin", "password": "'"${{ secrets.ALIST_ADMIN_PW }}"'"}' | jq -r .data.token)
        
         # æ£€æŸ¥å­˜å‚¨æ˜¯å¦æ¿€æ´»
         if curl -s http://localhost:5244/api/admin/storage/list -H "Authorization: $TOKEN" | grep -q "work"; then
           echo "âœ… å­˜å‚¨é…ç½®æˆåŠŸ"
          else
           echo "âŒ å­˜å‚¨æœªæ¿€æ´»ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
           exit 1
         fi
    # ========== ç¬¬äºŒé˜¶æ®µï¼šè¾“å…¥éªŒè¯ ==========
    - name: éªŒè¯è¾“å…¥å‚æ•°
      run: |
        # éªŒè¯URLæ ¼å¼
        if [[ ! "${{ github.event.inputs.download_url }}" =~ ^https?:// ]]; then
          echo "âŒ é”™è¯¯ï¼šéæ³•çš„URLæ ¼å¼ï¼Œå¿…é¡»ä»¥ http:// æˆ– https:// å¼€å¤´"
          exit 1
        fi

        # æ ‡å‡†åŒ–äº‘ç«¯è·¯å¾„æ ¼å¼
        CLOUD_PATH="${{ github.event.inputs.cloud_path || '/è‡ªåŠ¨å¤‡ä»½/'}}"
        if [[ ! "$CLOUD_PATH" =~ /$ ]]; then
          CLOUD_PATH="${CLOUD_PATH}/"  # ç¡®ä¿è·¯å¾„ä»¥/ç»“å°¾
        fi
        echo "CLOUD_PATH=${CLOUD_PATH}" >> $GITHUB_ENV

    # ========== ç¬¬å››é˜¶æ®µï¼šæ–‡ä»¶ä¸‹è½½ ==========
    - name: æ™ºèƒ½ä¸‹è½½æ–‡ä»¶
      run: |
        # æå–æ–‡ä»¶åå¹¶å¤„ç†ç‰¹æ®Šå­—ç¬¦
        RAW_URL="${{ github.event.inputs.download_url }}"
        FILENAME=$(basename "${RAW_URL%%\?*}" | sed 's/%20/ /g')  # å»é™¤URLå‚æ•°å¹¶è§£ç ç©ºæ ¼
        
        # é€šè¿‡Aria2ä¸‹è½½
        curl -s http://localhost:6800/jsonrpc \
          -H "Content-Type: application/json" \
          -d '{
            "jsonrpc": "2.0",
            "id": "github-action",
            "method": "aria2.addUri",
            "params": [
              "token:${{ secrets.ARIA2_TOKEN }}",
              ["'"$RAW_URL"'"],
              {
                "dir": "/opt/alist/data/downloads",
                "out": "'"$FILENAME"'",
                "split": "10",
                "max-connection-per-server": "8",
                "allow-overwrite": "true"
              }
            ]
          }'

        # ç›‘æ§ä¸‹è½½è¿›åº¦ï¼ˆæœ€é•¿ç­‰å¾…6å°æ—¶ï¼‰
        timeout 6h bash -c '
          while true; do
            STATUS=$(curl -s http://localhost:6800/jsonrpc \
              -d "{\"jsonrpc\":\"2.0\",\"id\":\"1\",\"method\":\"aria2.tellActive\",\"params\":[\"token:${{ secrets.ARIA2_TOKEN }}\"]}")
            if [ $(echo "$STATUS" | jq ".result | length") -eq 0 ]; then
              break
            fi
            echo "âŒ› ä¸‹è½½è¿›åº¦ï¼š$(echo "$STATUS" | jq ".result[0].completedLength")/$(echo "$STATUS" | jq ".result[0].totalLength")"
            sleep 30
          done
        ' || echo "âš ï¸ è­¦å‘Šï¼šä¸‹è½½ä»»åŠ¡å¯èƒ½æœªå®Œæˆ"

    # ========== ç¬¬äº”é˜¶æ®µï¼šæ–‡ä»¶ä¸Šä¼  ==========
    - name: å®‰å…¨ä¸Šä¼ åˆ°å¤©ç¿¼äº‘
      run: |
        FILENAME=$(basename "${{ github.event.inputs.download_url }}" | sed 's/%20/ /g')
        LOCAL_PATH="/opt/alist/data/downloads/$FILENAME"

        # è·å–ç®¡ç†å‘˜Token
        TOKEN=$(curl -s -X POST http://localhost:5244/api/auth/login \
          -H "Content-Type: application/json" \
          -d '{"username": "admin", "password": "'"${{ secrets.ALIST_ADMIN_PW }}"'"}' | jq -r .data.token)

        # åˆ†å—ä¸Šä¼ ï¼ˆé€‚åˆå¤§æ–‡ä»¶ï¼‰
        curl -X PUT http://localhost:5244/api/fs/form \
          -H "Authorization: $TOKEN" \
          -F "path=/tianyi-cloud/$FILENAME" \
          -F "file=@$LOCAL_PATH" \
          -F "chunk_index=0" \
          -F "chunk_count=1"

    # ========== ç¬¬å…­é˜¶æ®µï¼šæ”¶å°¾å·¥ä½œ ==========
    - name: æ¸…ç†å’Œæ—¥å¿—
      if: always()
      run: |
        # è·å–å®¹å™¨æ—¥å¿—
        docker logs alist-aio > alist.log 2>&1

        # æ¸…ç†å®¹å™¨
        docker stop alist-aio || true
        docker rm alist-aio || true

        # ä¸Šä¼ æ—¥å¿—ä¾›è°ƒè¯•
        echo "========== AListæ—¥å¿— =========="
        cat alist.log
