name: Alist-AIO è‡ªåŠ¨åŒ–ä¼ è¾“

on:
  workflow_dispatch:

jobs:
  alist-automation:
    runs-on: ubuntu-latest
    steps:
    # ========== åˆå§‹é˜¶æ®µï¼šå†…ç½‘ç©¿é€ ==========
    - name: ä½¿ç”¨ cpolar æš´éœ²ç«¯å£
      run: |
        # ä¸‹è½½ cpolar
        wget https://www.cpolar.com/static/downloads/releases/3.3.18/cpolar-stable-linux-amd64.zip
        unzip cpolar-stable-linux-amd64.zip
        
        # è®¾ç½®è®¤è¯ä»¤ç‰Œï¼ˆåœ¨ https://dashboard.cpolar.com è·å–ï¼‰
        ./cpolar authtoken ${{ secrets.CPOLAR_TOKEN }} 
        
        # å¯åŠ¨éš§é“
        ./cpolar http 9000 > /dev/null &
        
    - name: å¯åŠ¨portainerå®¹å™¨
      run: |
        docker run -d --restart=always --name="portainer" -p 9000:9000 -v /var/run/docker.sock:/var/run/docker.sock 6053537/portainer-ce

    - name: ä½¿ç”¨ Ngrok æš´éœ²ç«¯å£
      run: |
        # ä¸‹è½½ ngrok
        wget https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar xvzf ngrok-v3-stable-linux-amd64.tgz
        
        # è®¾ç½®è®¤è¯ä»¤ç‰Œï¼ˆåœ¨ https://dashboard.ngrok.com è·å–ï¼‰
        ./ngrok authtoken ${{ secrets.NGROK_TOKEN }}
        
        # å¯åŠ¨éš§é“
        ./ngrok http 5244 > /dev/null &
        
        # è·å–å…¬å…± URL
        sleep 3
        NGROK_URL=$(curl -s localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        
    # ========== ç¬¬ä¸€é˜¶æ®µï¼šå®¹å™¨åˆå§‹åŒ– ==========
    - name: å¯åŠ¨Alist-AIOå®¹å™¨
      run: |
        docker run -d --name alist-aio \
          -p 5244:5244 \
          -p 6800:6800 \
          xhofe/alist:latest-aio
          docker exec alist-aio ./alist admin set admin
          echo "ğŸŒ Alist å·²æš´éœ²åœ¨å…¬ç½‘: $NGROK_URL"          
          echo "â³ ç­‰å¾…æ‰‹åŠ¨é…ç½®å¤©ç¿¼äº‘å­˜å‚¨..."
          echo "ğŸ‘‰ é¢„ç•™6å°æ—¶æ‰‹åŠ¨æ“ä½œæ—¶é—´"
        sleep 6h

    # ========== ç¬¬äºŒé˜¶æ®µï¼šæ”¶å°¾å·¥ä½œ ==========
    - name: æ¸…ç†å’Œæ—¥å¿—
      if: always()
      run: |
        # è·å–å®¹å™¨æ—¥å¿—
        docker logs alist-aio > alist.log 2>&1

        # æ¸…ç†å®¹å™¨
        docker stop alist-aio || true
        docker rm alist-aio || true

        # ä¸Šä¼ æ—¥å¿—ä¾›è°ƒè¯•
        echo "========== AListæ—¥å¿— =========="
        cat alist.log
