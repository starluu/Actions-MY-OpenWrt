#!/bin/sh
#==========================================================

# config path
make_path="$(pwd)"
openwrt_dir="openwrt"
imagebuilder_path="${make_path}/${openwrt_dir}"

# config repo
imagebuilder_repo="https://downloads.openwrt.org/snapshots/targets/x86/generic/openwrt-imagebuilder-x86-generic.Linux-x86_64.tar.xz"
luci_lib_fs="https://downloads.immortalwrt.org/snapshots/packages/i386_pentium4/luci/luci-lib-fs_1.0-2_all.ipk"
luci_app_vsftpd="https://downloads.immortalwrt.org/snapshots/packages/i386_pentium4/luci/luci-app-vsftpd_git-23.305.13420-fbde5ce_all.ipk"
luci_i18n_vsftpd_zh_cn="https://downloads.immortalwrt.org/snapshots/packages/i386_pentium4/luci/luci-i18n-vsftpd-zh-cn_git-23.305.13420-fbde5ce_all.ipk"
luci_app_diskman="https://downloads.immortalwrt.org/snapshots/packages/i386_pentium4/luci/luci-app-diskman_0.2.11_all.ipk"
luci_i18n_diskman_zh_cn="https://downloads.immortalwrt.org/snapshots/packages/i386_pentium4/luci/luci-i18n-diskman-zh-cn_git-23.305.13420-fbde5ce_all.ipk"
alist="https://github.com/sbwml/luci-app-alist/releases/download/v3.29.1/openwrt-22.03-i386_pentium4.tar.gz"

# config package
unused_packages="-luci-app-cpufreq"
driver_packages=""
default_luci="luci luci-i18n-base-zh-cn luci-i18n-firewall-zh-cn luci-i18n-opkg-zh-cn luci-compat luci-lib-base luci-lib-fs luci-lib-ipkg"
my_packages="${default_luci} luci-i18n-alist-zh-cn ariang luci-i18n-aria2-zh-cn luci-i18n-samba4-zh-cn luci-i18n-vsftpd-zh-cn luci-i18n-diskman-zh-cn luci-theme-material ${driver_packages} ${unused_packages}"

error_msg() {
    echo -e "${ERROR} ${1}"
    exit 1
}

download_imagebuilder () {
    wget ${imagebuilder_repo} || error_msg
    tar -xJf openwrt-imagebuilder-* && rm -f openwrt-imagebuilder-*.tar.xz
    mv -f openwrt-imagebuilder-* ${openwrt_dir}
    sed -i "s|CONFIG_TARGET_ROOTFS_PARTSIZE=104|CONFIG_TARGET_ROOTFS_PARTSIZE=320|g" ${imagebuilder_path}/.config || error_msg
}

custom_packages () {
    wget -P ${imagebuilder_path}/packages/ ${luci_lib_fs} || error_msg
    wget -P ${imagebuilder_path}/packages/ ${luci_app_vsftpd} || error_msg
    wget -P ${imagebuilder_path}/packages/ ${luci_i18n_vsftpd_zh_cn} || error_msg
    wget -P ${imagebuilder_path}/packages/ ${luci_app_diskman} || error_msg
    wget -P ${imagebuilder_path}/packages/ ${luci_i18n_diskman_zh_cn} || error_msg
    wget ${alist} || error_msg
    tar -zxvf openwrt-22.03-i386_pentium4.tar.gz -C ${imagebuilder_path}/packages/
}

build_firmware () {
    cd ${imagebuilder_path}
    make image PROFILE="generic" PACKAGES="${my_packages}" FILES="files" || error_msg
    echo "success..."
}

download_imagebuilder
custom_packages
build_firmware

exit 0
